<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Test - Lumina Smiles</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4af37;
        }
        button {
            background: #d4af37;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #b8941f;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .log-success { background: #d4edda; }
        .log-error { background: #f8d7da; }
        .log-info { background: #d1ecf1; }
        .test-buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .test-btn {
            background: #6c757d;
            padding: 10px 20px;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #5a6268;
        }
        .webhook-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .status-unknown { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Webhook & Form Test</h1>
        <p>This page helps you test both the form submission and webhook functionality for the Lumina Smiles website.</p>
        
        <div class="webhook-info">
            <h3>Webhook Configuration</h3>
            <p><strong>URL:</strong> <span id="webhookUrl">Loading...</span> <span id="webhookStatus" class="webhook-status status-unknown">Unknown</span></p>
            <p><strong>Status:</strong> <span id="webhookStatusText">Checking...</span></p>
        </div>

        <div class="test-buttons">
            <button class="test-btn" onclick="testWebhookDirectly()">Test Webhook Directly</button>
            <button class="test-btn" onclick="testFormSubmission()">Test Form Submission</button>
            <button class="test-btn" onclick="clearLogs()">Clear Logs</button>
            <button class="test-btn" onclick="exportLogs()">Export Logs</button>
        </div>

        <form id="testForm" name="contact" method="POST" data-netlify="true" netlify-honeypot="bot-field">
            <input type="hidden" name="form-name" value="contact" />
            <p class="hidden">
                <label>Don't fill this out if you're human: <input name="bot-field" /></label>
            </p>
            
            <div class="form-group">
                <label for="name">Full Name *</label>
                <input type="text" id="name" name="name" required value="Test User">
            </div>
            
            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required value="test@example.com">
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required value="+1234567890">
            </div>
            
            <div class="form-group">
                <label for="service">Service *</label>
                <select id="service" name="service" required>
                    <option value="">Select a Service</option>
                    <option value="teeth-whitening" selected>Teeth Whitening</option>
                    <option value="porcelain-veneers">Porcelain Veneers</option>
                    <option value="invisalign">Invisalign</option>
                    <option value="smile-makeover">Smile Makeover</option>
                    <option value="botox">Botox & Facial Aesthetics</option>
                    <option value="consultation">General Consultation</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="message">Message (Optional)</label>
                <textarea id="message" name="message" rows="4">This is a test message from the webhook test page.</textarea>
            </div>
            
            <button type="submit" id="submitBtn">Submit Test Form</button>
        </form>
        
        <div id="result"></div>
        
        <div class="log-container">
            <h4>Test Logs</h4>
            <div id="logOutput"></div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script>
        // Global variables
        let testCounter = 0;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded', 'info');
            checkWebhookConfiguration();
            setupFormHandler();
        });
        
        // Check webhook configuration
        function checkWebhookConfiguration() {
            const webhookUrl = typeof CONFIG !== 'undefined' ? CONFIG.MAKE_WEBHOOK_URL : null;
            const urlElement = document.getElementById('webhookUrl');
            const statusElement = document.getElementById('webhookStatus');
            const statusTextElement = document.getElementById('webhookStatusText');
            
            if (webhookUrl) {
                urlElement.textContent = webhookUrl;
                statusElement.textContent = 'Configured';
                statusElement.className = 'webhook-status status-ok';
                statusTextElement.textContent = 'Webhook URL is configured';
                log('Webhook URL found: ' + webhookUrl, 'success');
            } else {
                urlElement.textContent = 'Not configured';
                statusElement.textContent = 'Missing';
                statusElement.className = 'webhook-status status-error';
                statusTextElement.textContent = 'Webhook URL not found in config.js';
                log('Webhook URL not configured', 'error');
            }
        }
        
        // Setup form handler
        function setupFormHandler() {
            document.getElementById('testForm').addEventListener('submit', function(e) {
                e.preventDefault();
                testCounter++;
                
                const formData = new FormData(this);
                const resultDiv = document.getElementById('result');
                
                // Check honeypot
                if (formData.get('bot-field')) {
                    log('Bot detected - form submission blocked', 'error');
                    resultDiv.innerHTML = '<div class="result error">Bot detected - form submission blocked</div>';
                    return;
                }
                
                // Prepare data
                const formObject = {};
                formData.forEach((value, key) => {
                    if (key !== 'bot-field' && key !== 'form-name') {
                        formObject[key] = value;
                    }
                });
                
                // Add timestamp and source
                formObject.timestamp = new Date().toISOString();
                formObject.source = 'webhook-test-page';
                formObject.testId = `test-${testCounter}`;
                
                log(`Starting form submission test #${testCounter}`, 'info');
                log('Form data: ' + JSON.stringify(formObject, null, 2), 'info');
                
                // Show loading
                resultDiv.innerHTML = '<div class="result info">Submitting form and testing webhook...</div>';
                
                // Test both Netlify function and webhook
                testFormSubmissionWithWebhook(formObject);
            });
        }
        
        // Test form submission with webhook
        function testFormSubmissionWithWebhook(formObject) {
            const resultDiv = document.getElementById('result');
            
            // First, try to submit to Netlify function
            log('Attempting to submit to Netlify function...', 'info');
            
            fetch('/.netlify/functions/submit-form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formObject)
            })
            .then(response => {
                log(`Netlify function response status: ${response.status}`, 'info');
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`Netlify function failed with status: ${response.status}`);
                }
            })
            .then(data => {
                log('Netlify function response: ' + JSON.stringify(data, null, 2), 'success');
                
                // Now test webhook
                log('Testing webhook...', 'info');
                return testWebhook(formObject);
            })
            .then(webhookResult => {
                resultDiv.innerHTML = `
                    <div class="result success">
                        <h4>✅ Test Completed Successfully!</h4>
                        <p><strong>Form Submission:</strong> ✅ Success</p>
                        <p><strong>Webhook:</strong> ${webhookResult ? '✅ Success' : '❌ Failed'}</p>
                        <p><strong>Test ID:</strong> ${formObject.testId}</p>
                        <p>Check the logs below for detailed information.</p>
                    </div>
                `;
                document.getElementById('testForm').reset();
            })
            .catch(error => {
                log('Netlify function error: ' + error.message, 'error');
                
                // Fallback: test webhook directly
                log('Testing webhook as fallback...', 'info');
                testWebhook(formObject).then(webhookResult => {
                    resultDiv.innerHTML = `
                        <div class="result ${webhookResult ? 'success' : 'error'}">
                            <h4>${webhookResult ? '⚠️' : '❌'} Test Results</h4>
                            <p><strong>Form Submission:</strong> ❌ Failed (Netlify function unavailable)</p>
                            <p><strong>Webhook:</strong> ${webhookResult ? '✅ Success' : '❌ Failed'}</p>
                            <p><strong>Test ID:</strong> ${formObject.testId}</p>
                            <p>Check the logs below for detailed information.</p>
                        </div>
                    `;
                });
            });
        }
        
        // Test webhook directly
        function testWebhookDirectly() {
            testCounter++;
            const testData = {
                name: 'Direct Webhook Test',
                email: 'direct-test@example.com',
                phone: '+1234567890',
                service: 'consultation',
                message: 'This is a direct webhook test',
                timestamp: new Date().toISOString(),
                source: 'direct-webhook-test',
                testId: `direct-test-${testCounter}`
            };
            
            log(`Starting direct webhook test #${testCounter}`, 'info');
            log('Test data: ' + JSON.stringify(testData, null, 2), 'info');
            
            testWebhook(testData).then(success => {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="result ${success ? 'success' : 'error'}">
                        <h4>${success ? '✅' : '❌'} Direct Webhook Test</h4>
                        <p><strong>Result:</strong> ${success ? 'Success' : 'Failed'}</p>
                        <p><strong>Test ID:</strong> ${testData.testId}</p>
                        <p>Check the logs below for detailed information.</p>
                    </div>
                `;
            });
        }
        
        // Test webhook function
        function testWebhook(formData) {
            return new Promise((resolve) => {
                const webhookUrl = typeof CONFIG !== 'undefined' ? CONFIG.MAKE_WEBHOOK_URL : null;
                
                if (!webhookUrl) {
                    log('Webhook URL not configured', 'error');
                    resolve(false);
                    return;
                }
                
                log('Sending webhook to: ' + webhookUrl, 'info');
                
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    log(`Webhook response status: ${response.status}`, 'info');
                    if (response.ok) {
                        log('Webhook triggered successfully', 'success');
                        resolve(true);
                    } else {
                        log(`Webhook failed with status: ${response.status}`, 'error');
                        resolve(false);
                    }
                })
                .catch(error => {
                    log('Webhook error: ' + error.message, 'error');
                    resolve(false);
                });
            });
        }
        
        // Test form submission (simplified)
        function testFormSubmission() {
            testCounter++;
            log(`Starting simplified form test #${testCounter}`, 'info');
            
            const testData = {
                name: 'Form Test User',
                email: 'form-test@example.com',
                phone: '+1234567890',
                service: 'teeth-whitening',
                message: 'This is a form submission test',
                timestamp: new Date().toISOString(),
                source: 'form-test',
                testId: `form-test-${testCounter}`
            };
            
            log('Test data: ' + JSON.stringify(testData, null, 2), 'info');
            
            // Test both form submission and webhook
            testFormSubmissionWithWebhook(testData);
        }
        
        // Logging function
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            
            // Also log to console
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Clear logs
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        // Export logs
        function exportLogs() {
            const logOutput = document.getElementById('logOutput');
            const logs = logOutput.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webhook-test-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Logs exported', 'success');
        }
    </script>
</body>
</html>